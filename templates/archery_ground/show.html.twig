{% extends 'base.html.twig' %}

{% block title %}{{ archeryGround.name }} · Archery Ground{% endblock %}

{% block body %}
<section class="page-header">
    <div>
        <h1>{{ archeryGround.name }}</h1>
        <p class="muted">ID {{ archeryGround.id }}</p>
    </div>
    <div class="inline-actions">
        <form method="post" action="{{ path('archery_ground_rename', {id: archeryGround.id}) }}" class="inline-form">
            <input type="text" name="name" value="{{ archeryGround.name }}" aria-label="Rename archery ground">
            <button class="button" type="submit">Rename</button>
        </form>
        <form method="post" action="{{ path('archery_ground_delete', {id: archeryGround.id}) }}" onsubmit="return confirm('Delete this archery ground?')">
            <button class="button danger" type="submit">Delete</button>
        </form>
    </div>
</section>

<div class="split">
    <section class="panel">
        <div class="panel-header">
            <h2>Lanes</h2>
            <span class="badge">{{ archeryGround.shootingLanes|length }}</span>
        </div>
        <form method="post" class="form" action="{{ path('archery_ground_add_lane', {id: archeryGround.id}) }}">
            <div class="form-row">
                <label class="field">
                    <span>Lane name</span>
                    <input type="text" name="name" placeholder="Lane 1" required>
                </label>
                <label class="field">
                    <span>Max distance (m)</span>
                    <input type="number" name="max_distance" step="0.1" min="0.1" placeholder="30" required>
                </label>
            </div>
            <button class="button" type="submit">Add lane</button>
        </form>

        <div class="table lanes">
            <div class="table-row table-head">
                <div>Name</div>
                <div>Max Distance</div>
                <div></div>
            </div>
            {% for lane in archeryGround.shootingLanes %}
                <div class="table-row">
                    <div>{{ lane.name }}</div>
                    <div>{{ lane.maxDistance }} m</div>
                    <div class="table-actions">
                        <form method="post" action="{{ path('archery_ground_delete_lane', {id: archeryGround.id, laneId: lane.id}) }}" onsubmit="return confirm('Remove this lane?')">
                            <button class="link" type="submit">Remove</button>
                        </form>
                    </div>
                </div>
            {% else %}
                <div class="table-row empty">
                    <div>No lanes yet.</div>
                </div>
            {% endfor %}
        </div>
    </section>

    <section class="panel">
        <div class="panel-header">
            <h2>Targets</h2>
            <span class="badge">{{ archeryGround.targetStorage|length }}</span>
        </div>
        <form method="post" class="form" action="{{ path('archery_ground_add_target', {id: archeryGround.id}) }}" enctype="multipart/form-data">
            <div class="form-row">
                <label class="field">
                    <span>Type</span>
                    <select name="type" required>
                        {% for type in targetTypes %}
                            <option value="{{ type.value }}">{{ type.value }}</option>
                        {% endfor %}
                    </select>
                </label>
                <label class="field">
                    <span>Target name</span>
                    <input type="text" name="name" placeholder="Deer" required>
                </label>
                <label class="field">
                    <span>Target image</span>
                    <div class="dropzone" data-dropzone>
                        <input type="file" name="image" accept="image/*" required>
                        <div class="dropzone-content">
                            <strong>Drag & drop</strong> or click to upload
                            <span class="dropzone-hint">PNG, JPG, WEBP, or GIF</span>
                        </div>
                        <div class="dropzone-preview" hidden>
                            <img src="" alt="Selected target preview">
                            <div>
                                <div class="dropzone-filename"></div>
                                <div class="dropzone-hint">Drop a new image to replace</div>
                            </div>
                        </div>
                    </div>
                </label>
            </div>
            <button class="button" type="submit">Add target</button>
        </form>

        <div class="filter-bar" role="search" aria-label="Filter targets">
            <label class="field">
                <span>Search</span>
                <input type="text" id="target-filter" placeholder="Search by name">
            </label>
            <label class="field">
                <span>Type</span>
                <select id="target-type-filter">
                    <option value="">All types</option>
                    {% for type in targetTypes %}
                        <option value="{{ type.value }}">{{ type.value }}</option>
                    {% endfor %}
                </select>
            </label>
            <button class="button ghost" type="button" id="target-filter-reset">Reset</button>
        </div>
        <p class="filter-count" id="target-filter-count"></p>

        <div class="table targets">
            <div class="table-row table-head">
                <div>Name</div>
                <div>Type</div>
                <div>Image</div>
                <div></div>
            </div>
            {% for target in archeryGround.targetStorage %}
                <div class="table-row target-row" data-name="{{ target.name|lower }}" data-type="{{ target.type.value }}">
                    <div>{{ target.name }}</div>
                    <div>{{ target.type.value }}</div>
                    <div class="image-cell">
                        {% if target.image %}
                            <div class="image-preview">
                                <img src="{{ target.image }}" alt="{{ target.name }}">
                                <div class="preview-pop">
                                    <img src="{{ target.image }}" alt="{{ target.name }} preview">
                                </div>
                            </div>
                        {% else %}
                            -
                        {% endif %}
                    </div>
                    <div class="table-actions">
                        <form method="post" action="{{ path('archery_ground_delete_target', {id: archeryGround.id, targetId: target.id}) }}" onsubmit="return confirm('Remove this target?')">
                            <button class="link" type="submit">Remove</button>
                        </form>
                    </div>
                </div>
            {% else %}
                <div class="table-row empty">
                    <div>No targets yet.</div>
                </div>
            {% endfor %}
            <div class="table-row empty target-empty" style="display: none;">
                <div>No targets match your filter.</div>
            </div>
        </div>
    </section>
</div>

<section class="panel panel-spaced">
    <div class="panel-header">
        <h2>Tournaments</h2>
        <span class="badge">{{ tournaments|default([])|length }}</span>
    </div>
    <p class="muted">Create and manage tournaments for this archery ground. Upcoming tournaments are shown first.</p>
    <div class="inline-actions">
        <a class="button" href="{{ path('tournament_new', {archery_ground_id: archeryGround.id, mode: 'auto'}) }}">Auto-generate tournament</a>
        <a class="button ghost" href="{{ path('tournament_new', {archery_ground_id: archeryGround.id, mode: 'manual'}) }}">Manual tournament</a>
    </div>

    {% set today = "now"|date('Y-m-d') %}
    {% set soon = "now"|date_modify('+14 days')|date('Y-m-d') %}

    {% if nextTournament is defined and nextTournament %}
        {% set nextDate = nextTournament.eventDate|date('Y-m-d') %}
        {% if nextDate < today %}
            {% set nextStatus = 'past' %}
        {% elseif nextDate == today %}
            {% set nextStatus = 'today' %}
        {% elseif nextDate <= soon %}
            {% set nextStatus = 'upcoming' %}
        {% else %}
            {% set nextStatus = 'future' %}
        {% endif %}
        <div class="next-tournament">
            <div>
                <strong>Next tournament:</strong> {{ nextTournament.name }} · {{ nextTournament.eventDate|date('Y-m-d') }}
                <span class="status-pill {{ nextStatus }}">{{ nextStatus|capitalize }}</span>
            </div>
            <div class="next-tournament__actions">
                <a class="button ghost" href="{{ path('tournament_show', {id: nextTournament.id}) }}">Manage</a>
                <a class="button ghost" href="{{ path('tournament_view', {id: nextTournament.id}) }}">View mode</a>
            </div>
        </div>
    {% endif %}

    <div class="grid tournament-grid">
        {% for tournament in tournaments|default([]) %}
            {% set eventDate = tournament.eventDate|date('Y-m-d') %}
            {% if eventDate < today %}
                {% set status = 'past' %}
            {% elseif eventDate == today %}
                {% set status = 'today' %}
            {% elseif eventDate <= soon %}
                {% set status = 'upcoming' %}
            {% else %}
                {% set status = 'future' %}
            {% endif %}
            <article class="card tournament-card tournament-card--{{ status }}">
                <div class="tournament-card__top">
                    <div>
                        <h2>{{ tournament.name }}</h2>
                        <p class="muted">{{ tournament.eventDate|date('Y-m-d') }}</p>
                    </div>
                    <div class="tournament-card__tags">
                        <span class="status-pill {{ status }}">{{ status|capitalize }}</span>
                        <span class="badge">{{ tournament.ruleset.value }}</span>
                    </div>
                </div>
                <div class="tournament-card__stats">
                    <div class="tournament-card__stat">
                        <strong>{{ tournament.numberOfTargets }}</strong>
                        <span>Targets</span>
                    </div>
                    <div class="tournament-card__stat">
                        <strong>{{ tournament.targets|length }}</strong>
                        <span>Assigned</span>
                    </div>
                </div>
                <div class="tournament-card__actions">
                    <a class="button ghost" href="{{ path('tournament_show', {id: tournament.id}) }}">Manage</a>
                    <a class="button ghost" href="{{ path('tournament_view', {id: tournament.id}) }}">View mode</a>
                </div>
            </article>
        {% else %}
            <div class="empty-state">
                <h2>No tournaments yet</h2>
                <p>Create your first tournament for this archery ground.</p>
                <a class="button" href="{{ path('tournament_new', {archery_ground_id: archeryGround.id}) }}">Create tournament</a>
            </div>
        {% endfor %}
    </div>
</section>

<script>
(() => {
    const input = document.getElementById('target-filter');
    const select = document.getElementById('target-type-filter');
    const reset = document.getElementById('target-filter-reset');
    const rows = Array.from(document.querySelectorAll('.target-row'));
    const countEl = document.getElementById('target-filter-count');
    const emptyEl = document.querySelector('.target-empty');
    const total = rows.length;

    if (!input || !select || !reset) {
        return;
    }

    const update = () => {
        const term = input.value.trim().toLowerCase();
        const type = select.value;
        let visible = 0;

        rows.forEach((row) => {
            const name = row.dataset.name || '';
            const rowType = row.dataset.type || '';
            const matchesName = term === '' || name.includes(term);
            const matchesType = type === '' || rowType === type;
            const show = matchesName && matchesType;
            row.style.display = show ? '' : 'none';
            if (show) {
                visible += 1;
            }
        });

        if (countEl) {
            if (total === 0) {
                countEl.textContent = '';
            } else {
                countEl.textContent = `Showing ${visible} of ${total}`;
            }
        }

        if (emptyEl) {
            emptyEl.style.display = total > 0 && visible === 0 ? '' : 'none';
        }
    };

    input.addEventListener('input', update);
    select.addEventListener('change', update);
    reset.addEventListener('click', () => {
        input.value = '';
        select.value = '';
        update();
    });

    update();

    const dropzone = document.querySelector('[data-dropzone]');
    if (dropzone instanceof HTMLElement) {
        const fileInput = dropzone.querySelector('input[type="file"]');
        const preview = dropzone.querySelector('.dropzone-preview');
        const previewImage = dropzone.querySelector('.dropzone-preview img');
        const previewName = dropzone.querySelector('.dropzone-filename');
        const content = dropzone.querySelector('.dropzone-content');

        const updatePreview = (file) => {
            if (!preview || !previewImage || !previewName || !content) {
                return;
            }

            previewImage.src = URL.createObjectURL(file);
            previewImage.onload = () => URL.revokeObjectURL(previewImage.src);
            previewName.textContent = file.name;
            preview.hidden = false;
            content.hidden = true;
        };

        const resetPreview = () => {
            if (!preview || !previewImage || !previewName || !content) {
                return;
            }

            preview.hidden = true;
            content.hidden = false;
            previewImage.src = '';
            previewName.textContent = '';
        };

        dropzone.addEventListener('dragenter', (event) => {
            event.preventDefault();
            dropzone.classList.add('is-dragging');
        });

        dropzone.addEventListener('dragover', (event) => {
            event.preventDefault();
            dropzone.classList.add('is-dragging');
        });

        dropzone.addEventListener('dragleave', () => {
            dropzone.classList.remove('is-dragging');
        });

        dropzone.addEventListener('drop', (event) => {
            event.preventDefault();
            dropzone.classList.remove('is-dragging');
            if (!fileInput) {
                return;
            }

            const [file] = event.dataTransfer.files;
            if (!file) {
                resetPreview();
                return;
            }

            fileInput.files = event.dataTransfer.files;
            updatePreview(file);
        });

        if (fileInput) {
            fileInput.addEventListener('change', () => {
                const file = fileInput.files && fileInput.files[0];
                if (!file) {
                    resetPreview();
                    return;
                }

                updatePreview(file);
            });
        }
    }
})();
</script>
{% endblock %}
