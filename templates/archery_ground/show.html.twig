{% extends 'base.html.twig' %}

{% block title %}{{ archeryGround.name }} · Archery Ground{% endblock %}

{% set defaultTargetType = targetTypes|first %}

{% block body %}
<section class="page-header">
    <div>
        <h1>{{ archeryGround.name }}</h1>
        <div class="page-meta">
            <span class="meta-item">
                {{ ux_icon('lucide:hash', {class: 'icon'}) }}
                <span>{{ archeryGround.id }}</span>
            </span>
        </div>
    </div>
    <div class="inline-actions">
        <form method="post" action="{{ path('archery_ground_rename', {id: archeryGround.id}) }}" class="inline-form">
            <input type="hidden" name="_token" value="{{ csrf_token('archery_ground_rename_' ~ archeryGround.id) }}">
            <input type="text" name="name" value="{{ archeryGround.name }}" aria-label="Rename archery ground">
            <button class="button" type="submit">
                {{ ux_icon('lucide:pencil', {class: 'icon'}) }}
                <span>Rename</span>
            </button>
        </form>
        <form method="post" action="{{ path('archery_ground_delete', {id: archeryGround.id}) }}" onsubmit="return confirm('Delete this archery ground?')">
            <input type="hidden" name="_token" value="{{ csrf_token('archery_ground_delete_' ~ archeryGround.id) }}">
            <button class="button danger" type="submit">
                {{ ux_icon('lucide:trash-2', {class: 'icon'}) }}
                <span>Delete</span>
            </button>
        </form>
    </div>
</section>

<div class="split">
    <section class="panel">
        <div class="panel-header">
            <h2>Lanes</h2>
            <span class="badge">{{ archeryGround.shootingLanes|length }}</span>
            <button
                class="button js-add-lane"
                type="button"
                data-action="{{ path('archery_ground_add_lane', {id: archeryGround.id}) }}"
                data-token="{{ csrf_token('archery_ground_add_lane_' ~ archeryGround.id) }}"
            >
                {{ ux_icon('lucide:plus', {class: 'icon'}) }}
                <span>Add lane</span>
            </button>
        </div>

        <div class="table lanes">
            <div class="table-row table-head">
                <div>Name</div>
                <div>Max Distance</div>
                <div></div>
            </div>
            {% for lane in archeryGround.shootingLanes %}
                <div class="table-row">
                    <div>{{ lane.name }}</div>
                    <div>{{ lane.maxDistance }} m</div>
                    <div class="table-actions">
                        <button
                            class="icon-button js-edit-lane"
                            type="button"
                            aria-label="Edit lane {{ lane.name }}"
                            data-action="{{ path('archery_ground_update_lane', {id: archeryGround.id, laneId: lane.id}) }}"
                            data-token="{{ csrf_token('archery_ground_update_lane_' ~ archeryGround.id ~ '_' ~ lane.id) }}"
                            data-name="{{ lane.name }}"
                            data-distance="{{ lane.maxDistance }}"
                        >
                            {{ ux_icon('lucide:pencil', {class: 'icon'}) }}
                            <span class="sr-only">Edit</span>
                        </button>
                        <form method="post" action="{{ path('archery_ground_delete_lane', {id: archeryGround.id, laneId: lane.id}) }}" onsubmit="return confirm('Remove this lane?')">
                            <input type="hidden" name="_token" value="{{ csrf_token('archery_ground_delete_lane_' ~ archeryGround.id ~ '_' ~ lane.id) }}">
                            <button class="icon-button danger" type="submit" aria-label="Remove lane {{ lane.name }}">
                                {{ ux_icon('lucide:trash-2', {class: 'icon'}) }}
                                <span class="sr-only">Remove</span>
                            </button>
                        </form>
                    </div>
                </div>
            {% else %}
                <div class="table-row empty">
                    <div>No lanes yet.</div>
                </div>
            {% endfor %}
        </div>
    </section>

    <section class="panel">
        <div class="panel-header">
            <h2>Targets</h2>
            <span class="badge">{{ archeryGround.targetStorage|length }}</span>
            <button
                class="button js-add-target"
                type="button"
                data-action="{{ path('archery_ground_add_target', {id: archeryGround.id}) }}"
                data-token="{{ csrf_token('archery_ground_add_target_' ~ archeryGround.id) }}"
            >
                {{ ux_icon('lucide:plus', {class: 'icon'}) }}
                <span>Add target</span>
            </button>
        </div>

        <div class="filter-bar" role="search" aria-label="Filter targets">
            <label class="field">
                <span>Search</span>
                <input type="text" id="target-filter" placeholder="Search by name">
            </label>
            <label class="field">
                <span>Type</span>
                <div class="icon-select" data-icon-select>
                    <select id="target-type-filter" class="icon-select__native">
                        <option value="">All types</option>
                        {% for type in targetTypes %}
                            <option value="{{ type.value }}">{{ target_type_label(type.value) }}</option>
                        {% endfor %}
                    </select>
                    <button class="icon-select__trigger" type="button" aria-haspopup="listbox" aria-expanded="false">
                        <span class="icon-select__icon">
                            {{ ux_icon('lucide:layers', {class: 'icon'}) }}
                        </span>
                        <span class="icon-select__label">All types</span>
                        {{ ux_icon('lucide:chevron-down', {class: 'icon icon-select__chevron'}) }}
                    </button>
                    <div class="icon-select__options" role="listbox">
                        <button type="button" class="icon-select__option" data-value="" role="option" aria-selected="true">
                            <span class="icon-select__icon">
                                {{ ux_icon('lucide:layers', {class: 'icon'}) }}
                            </span>
                            <span class="icon-select__label">All types</span>
                        </button>
                        {% for type in targetTypes %}
                            <button type="button" class="icon-select__option" data-value="{{ type.value }}" role="option">
                                <span class="icon-select__icon">
                                    {{ ux_icon(target_type_icon(type.value), {class: 'icon'}) }}
                                </span>
                                <span class="icon-select__label">{{ target_type_label(type.value) }}</span>
                            </button>
                        {% endfor %}
                    </div>
                </div>
            </label>
            <button class="button ghost" type="button" id="target-filter-reset">
                {{ ux_icon('lucide:rotate-ccw', {class: 'icon'}) }}
                <span>Reset</span>
            </button>
        </div>
        <p class="filter-count" id="target-filter-count"></p>

        <div class="table targets">
            <div class="table-row table-head">
                <div>Image</div>
                <div>Target</div>
                <div></div>
            </div>
            {% for target in archeryGround.targetStorage %}
                <div class="table-row target-row" data-name="{{ target.name|lower }}" data-type="{{ target.type.value }}">
                    <div class="image-cell">
                        {% if target.image %}
                            <div class="image-preview" tabindex="0" role="button" aria-label="Preview {{ target.name }}">
                                <img src="{{ target.image }}" alt="{{ target.name }}">
                                <div class="preview-pop">
                                    <img src="{{ target.image }}" alt="{{ target.name }} preview">
                                </div>
                            </div>
                        {% else %}
                            -
                        {% endif %}
                    </div>
                    <div class="target-info">
                        <div class="target-name">
                            <span class="type-pill type-pill--inline" title="{{ target_type_label(target.type.value) }}">
                                {{ ux_icon(target_type_icon(target.type.value), {class: 'icon'}) }}
                            </span>
                            <span>{{ target.name }}</span>
                        </div>
                    </div>
                    <div class="table-actions target-actions">
                        <button
                            class="icon-button js-edit-image"
                            type="button"
                            aria-label="Edit image for {{ target.name }}"
                            data-action="{{ path('archery_ground_update_target_image', {id: archeryGround.id, targetId: target.id}) }}"
                            data-token="{{ csrf_token('archery_ground_update_target_image_' ~ archeryGround.id ~ '_' ~ target.id) }}"
                            data-name="{{ target.name }}"
                            data-image="{{ target.image }}"
                        >
                            {{ ux_icon('lucide:image', {class: 'icon'}) }}
                            <span class="sr-only">Edit image</span>
                        </button>
                        <form method="post" action="{{ path('archery_ground_delete_target', {id: archeryGround.id, targetId: target.id}) }}" onsubmit="return confirm('Remove this target?')">
                            <input type="hidden" name="_token" value="{{ csrf_token('archery_ground_delete_target_' ~ archeryGround.id ~ '_' ~ target.id) }}">
                            <button class="icon-button danger" type="submit" aria-label="Remove target {{ target.name }}">
                                {{ ux_icon('lucide:trash-2', {class: 'icon'}) }}
                                <span class="sr-only">Remove</span>
                            </button>
                        </form>
                    </div>
                </div>
            {% else %}
                <div class="table-row empty">
                    <div>No targets yet.</div>
                </div>
            {% endfor %}
            <div class="table-row empty target-empty" style="display: none;">
                <div>No targets match your filter.</div>
            </div>
        </div>
    </section>
</div>

<section class="panel panel-spaced">
    <div class="panel-header">
        <h2>Tournaments</h2>
        <span class="badge">{{ tournaments|default([])|length }}</span>
    </div>
    <p class="muted">Create and manage tournaments for this archery ground. Upcoming tournaments are shown first.</p>
    <div class="inline-actions">
        <a class="button" href="{{ path('tournament_new', {archery_ground_id: archeryGround.id, mode: 'auto'}) }}">
            {{ ux_icon('lucide:sparkles', {class: 'icon'}) }}
            <span>Auto-generate tournament</span>
        </a>
        <a class="button ghost" href="{{ path('tournament_new', {archery_ground_id: archeryGround.id, mode: 'manual'}) }}">
            {{ ux_icon('lucide:list-plus', {class: 'icon'}) }}
            <span>Manual tournament</span>
        </a>
    </div>

    {% set today = "now"|date('Y-m-d') %}
    {% set soon = "now"|date_modify('+14 days')|date('Y-m-d') %}

    {% if nextTournament is defined and nextTournament %}
        {% set nextDate = nextTournament.eventDate|date('Y-m-d') %}
        {% if nextDate < today %}
            {% set nextStatus = 'past' %}
        {% elseif nextDate == today %}
            {% set nextStatus = 'today' %}
        {% elseif nextDate <= soon %}
            {% set nextStatus = 'upcoming' %}
        {% else %}
            {% set nextStatus = 'future' %}
        {% endif %}
        <div class="next-tournament">
            <div>
                <strong>Next tournament:</strong> {{ nextTournament.name }} · {{ nextTournament.eventDate|date('Y-m-d') }}
                <span class="status-pill {{ nextStatus }}">{{ nextStatus|capitalize }}</span>
            </div>
            <div class="next-tournament__actions">
                <a class="button ghost" href="{{ path('tournament_show', {id: nextTournament.id}) }}">
                    {{ ux_icon('lucide:settings', {class: 'icon'}) }}
                    <span>Manage</span>
                </a>
                <a class="button ghost" href="{{ path('tournament_view', {id: nextTournament.id}) }}">
                    {{ ux_icon('lucide:eye', {class: 'icon'}) }}
                    <span>View</span>
                </a>
            </div>
        </div>
    {% endif %}

    <div class="grid tournament-grid">
        {% for tournament in tournaments|default([]) %}
            {% set eventDate = tournament.eventDate|date('Y-m-d') %}
            {% if eventDate < today %}
                {% set status = 'past' %}
            {% elseif eventDate == today %}
                {% set status = 'today' %}
            {% elseif eventDate <= soon %}
                {% set status = 'upcoming' %}
            {% else %}
                {% set status = 'future' %}
            {% endif %}
            <article class="card tournament-card tournament-card--{{ status }}">
                <div class="tournament-card__top">
                    <div>
                        <h2>{{ tournament.name }}</h2>
                        <p class="muted">{{ tournament.eventDate|date('Y-m-d') }}</p>
                    </div>
                    <div class="tournament-card__tags">
                        <span class="status-pill {{ status }}">{{ status|capitalize }}</span>
                        <span class="badge">{{ tournament.ruleset.value }}</span>
                    </div>
                </div>
                <div class="tournament-card__stats">
                    <div class="tournament-card__stat">
                        <strong>{{ tournament.numberOfTargets }}</strong>
                        <span>Targets</span>
                    </div>
                    <div class="tournament-card__stat">
                        <strong>{{ tournament.targets|length }}</strong>
                        <span>Assigned</span>
                    </div>
                </div>
                <div class="tournament-card__actions">
                    <a class="button ghost" href="{{ path('tournament_show', {id: tournament.id}) }}">
                        {{ ux_icon('lucide:settings', {class: 'icon'}) }}
                        <span>Manage</span>
                    </a>
                    <a class="button ghost" href="{{ path('tournament_view', {id: tournament.id}) }}">
                        {{ ux_icon('lucide:eye', {class: 'icon'}) }}
                        <span>View</span>
                    </a>
                    <form method="post" action="{{ path('tournament_delete', {id: tournament.id}) }}" onsubmit="return confirm('Delete this tournament?')">
                        <input type="hidden" name="_token" value="{{ csrf_token('tournament_delete_' ~ tournament.id) }}">
                        <button class="button ghost danger" type="submit">
                            {{ ux_icon('lucide:trash-2', {class: 'icon'}) }}
                            <span>Delete</span>
                        </button>
                    </form>
                </div>
            </article>
        {% else %}
            <div class="empty-state">
                <h2>No tournaments yet</h2>
                <p>Create your first tournament for this archery ground.</p>
                <a class="button" href="{{ path('tournament_new', {archery_ground_id: archeryGround.id}) }}">
                    {{ ux_icon('lucide:trophy', {class: 'icon'}) }}
                    <span>Create tournament</span>
                </a>
            </div>
        {% endfor %}
    </div>
</section>

<dialog id="lane-dialog" class="modal">
    <form method="post" id="lane-form" class="modal__body">
        <input type="hidden" name="_token" id="lane-token">
        <h3 id="lane-dialog-title">Edit lane <span id="lane-name-label"></span></h3>
        <label class="field">
            <span>Lane name</span>
            <input type="text" name="name" id="lane-name-input" placeholder="Lane 1" required>
        </label>
        <label class="field">
            <span>Max distance (m)</span>
            <input type="number" name="max_distance" id="lane-distance-input" min="0.1" step="0.1" placeholder="30" required>
        </label>
        <div class="modal__actions">
            <button class="button ghost" type="button" data-lane-close>Cancel</button>
            <button class="button" type="submit" id="lane-submit-btn">Save changes</button>
        </div>
    </form>
</dialog>

<dialog id="target-add-dialog" class="modal">
    <form method="post" enctype="multipart/form-data" id="target-add-form" class="modal__body">
        <input type="hidden" name="_token" id="target-add-token">
        <h3>Add target</h3>
        <label class="field">
            <span>Type</span>
            <div class="icon-select" data-icon-select>
                <select name="type" id="target-add-type" class="icon-select__native" required>
                    {% for type in targetTypes %}
                        <option value="{{ type.value }}">{{ target_type_label(type.value) }}</option>
                    {% endfor %}
                </select>
                {% if defaultTargetType %}
                    <button class="icon-select__trigger" type="button" aria-haspopup="listbox" aria-expanded="false">
                        <span class="icon-select__icon">
                            {{ ux_icon(target_type_icon(defaultTargetType.value), {class: 'icon'}) }}
                        </span>
                        <span class="icon-select__label">{{ target_type_label(defaultTargetType.value) }}</span>
                        {{ ux_icon('lucide:chevron-down', {class: 'icon icon-select__chevron'}) }}
                    </button>
                    <div class="icon-select__options" role="listbox">
                        {% for type in targetTypes %}
                            <button
                                type="button"
                                class="icon-select__option"
                                data-value="{{ type.value }}"
                                role="option"
                                aria-selected="{{ loop.first ? 'true' : 'false' }}"
                            >
                                <span class="icon-select__icon">
                                    {{ ux_icon(target_type_icon(type.value), {class: 'icon'}) }}
                                </span>
                                <span class="icon-select__label">{{ target_type_label(type.value) }}</span>
                            </button>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
        </label>
        <label class="field">
            <span>Target name</span>
            <input type="text" name="name" id="target-add-name" placeholder="Deer" required>
        </label>
        <label class="field">
            <span>Target image</span>
            <div class="dropzone" data-dropzone-modal>
                <input type="file" name="image" accept="image/*" required>
                <div class="dropzone-content">
                    <strong>Drag & drop</strong> or click to upload
                    <span class="dropzone-hint">PNG, JPG, WEBP, or GIF</span>
                </div>
                <div class="dropzone-preview" hidden>
                    <img src="" alt="Selected target preview">
                    <div>
                        <div class="dropzone-filename"></div>
                        <div class="dropzone-hint">Drop a new image to replace</div>
                    </div>
                </div>
            </div>
        </label>
        <div class="modal__actions">
            <button class="button ghost" type="button" data-target-add-close>Cancel</button>
            <button class="button" type="submit">Add target</button>
        </div>
    </form>
</dialog>

<dialog id="target-image-dialog" class="modal">
    <form method="post" enctype="multipart/form-data" id="target-image-form" class="modal__body">
        <input type="hidden" name="_token" id="target-image-token">
        <h3>Update image for <span id="target-image-name"></span></h3>
        <p class="muted">Upload a new image to replace the existing target photo.</p>
        <div class="modal__preview" id="target-image-preview-wrap" hidden>
            <img id="target-image-preview" alt="">
        </div>
        <label class="field">
            <span>New image</span>
            <input type="file" name="image" accept="image/*" required>
        </label>
        <div class="modal__actions">
            <button class="button ghost" type="button" data-dialog-close>Cancel</button>
            <button class="button" type="submit">Update image</button>
        </div>
    </form>
</dialog>
<script>
(() => {
    const input = document.getElementById('target-filter');
    const select = document.getElementById('target-type-filter');
    const reset = document.getElementById('target-filter-reset');
    const rows = Array.from(document.querySelectorAll('.target-row'));
    const countEl = document.getElementById('target-filter-count');
    const emptyEl = document.querySelector('.target-empty');
    const iconSelects = Array.from(document.querySelectorAll('[data-icon-select]'));

    const dialog = document.getElementById('target-image-dialog');
    const dialogForm = document.getElementById('target-image-form');
    const dialogToken = document.getElementById('target-image-token');
    const dialogName = document.getElementById('target-image-name');
    const dialogPreview = document.getElementById('target-image-preview');
    const dialogPreviewWrap = document.getElementById('target-image-preview-wrap');
    const dialogClose = document.querySelector('[data-dialog-close]');
    const laneDialog = document.getElementById('lane-dialog');
    const laneForm = document.getElementById('lane-form');
    const laneToken = document.getElementById('lane-token');
    const laneDialogTitle = document.getElementById('lane-dialog-title');
    const laneNameLabel = document.getElementById('lane-name-label');
    const laneNameInput = document.getElementById('lane-name-input');
    const laneDistanceInput = document.getElementById('lane-distance-input');
    const laneSubmitBtn = document.getElementById('lane-submit-btn');
    const laneClose = document.querySelector('[data-lane-close]');

    const targetAddDialog = document.getElementById('target-add-dialog');
    const targetAddForm = document.getElementById('target-add-form');
    const targetAddToken = document.getElementById('target-add-token');
    const targetAddName = document.getElementById('target-add-name');
    const targetAddClose = document.querySelector('[data-target-add-close]');

    const openDialog = (button) => {
        if (!dialog || !dialogForm || !dialogToken || !dialogName) {
            return;
        }

        dialogForm.setAttribute('action', button.dataset.action || '');
        dialogToken.value = button.dataset.token || '';
        dialogName.textContent = button.dataset.name || 'Target';

        if (dialogPreview && dialogPreviewWrap) {
            if (button.dataset.image) {
                dialogPreview.src = button.dataset.image;
                dialogPreviewWrap.hidden = false;
            } else {
                dialogPreview.src = '';
                dialogPreviewWrap.hidden = true;
            }
        }

        if (typeof dialog.showModal === 'function') {
            dialog.showModal();
        } else {
            dialog.classList.add('is-open');
        }
    };

    const closeDialog = () => {
        if (!dialog) {
            return;
        }

        if (typeof dialog.close === 'function') {
            dialog.close();
        } else {
            dialog.classList.remove('is-open');
        }
    };

    const openLaneDialog = (button, isEditMode = true) => {
        if (!laneDialog || !laneForm || !laneToken || !laneNameInput || !laneDistanceInput) {
            return;
        }

        laneForm.setAttribute('action', button.dataset.action || '');
        laneToken.value = button.dataset.token || '';

        if (isEditMode) {
            const laneName = button.dataset.name || 'Lane';
            if (laneDialogTitle) {
                laneDialogTitle.textContent = 'Edit lane ' + laneName;
            }
            laneNameLabel.textContent = laneName;
            laneNameInput.value = laneName;
            laneDistanceInput.value = button.dataset.distance || '';
            if (laneSubmitBtn) {
                laneSubmitBtn.textContent = 'Save changes';
            }
        } else {
            if (laneDialogTitle) {
                laneDialogTitle.textContent = 'Add lane';
            }
            laneNameLabel.textContent = '';
            laneNameInput.value = '';
            laneDistanceInput.value = '';
            if (laneSubmitBtn) {
                laneSubmitBtn.textContent = 'Add lane';
            }
        }

        if (typeof laneDialog.showModal === 'function') {
            laneDialog.showModal();
        } else {
            laneDialog.classList.add('is-open');
        }
    };

    const openTargetAddDialog = (button) => {
        if (!targetAddDialog || !targetAddForm || !targetAddToken) {
            return;
        }

        targetAddForm.setAttribute('action', button.dataset.action || '');
        targetAddToken.value = button.dataset.token || '';

        if (targetAddName) {
            targetAddName.value = '';
        }

        const modalDropzone = targetAddDialog.querySelector('[data-dropzone-modal]');
        if (modalDropzone) {
            const preview = modalDropzone.querySelector('.dropzone-preview');
            const content = modalDropzone.querySelector('.dropzone-content');
            const fileInput = modalDropzone.querySelector('input[type="file"]');
            if (preview) {
                preview.hidden = true;
            }
            if (content) {
                content.hidden = false;
            }
            if (fileInput) {
                fileInput.value = '';
            }
        }

        if (typeof targetAddDialog.showModal === 'function') {
            targetAddDialog.showModal();
        } else {
            targetAddDialog.classList.add('is-open');
        }
    };

    const closeTargetAddDialog = () => {
        if (!targetAddDialog) {
            return;
        }

        if (typeof targetAddDialog.close === 'function') {
            targetAddDialog.close();
        } else {
            targetAddDialog.classList.remove('is-open');
        }
    };

    const closeLaneDialog = () => {
        if (!laneDialog) {
            return;
        }

        if (typeof laneDialog.close === 'function') {
            laneDialog.close();
        } else {
            laneDialog.classList.remove('is-open');
        }
    };

    document.addEventListener('click', (event) => {
        const target = event.target;
        if (!(target instanceof Element)) {
            return;
        }

        const addLaneButton = target.closest('.js-add-lane');
        if (addLaneButton && addLaneButton instanceof HTMLElement) {
            event.preventDefault();
            openLaneDialog(addLaneButton, false);
            return;
        }

        const laneButton = target.closest('.js-edit-lane');
        if (laneButton && laneButton instanceof HTMLElement) {
            event.preventDefault();
            openLaneDialog(laneButton, true);
            return;
        }

        const addTargetButton = target.closest('.js-add-target');
        if (addTargetButton && addTargetButton instanceof HTMLElement) {
            event.preventDefault();
            openTargetAddDialog(addTargetButton);
            return;
        }

        const button = target.closest('.js-edit-image');
        if (!button || !(button instanceof HTMLElement)) {
            return;
        }

        event.preventDefault();
        openDialog(button);
    });

    if (dialogClose) {
        dialogClose.addEventListener('click', closeDialog);
    }

    if (dialog) {
        dialog.addEventListener('click', (event) => {
            if (event.target === dialog) {
                closeDialog();
            }
        });
    }

    if (laneClose) {
        laneClose.addEventListener('click', closeLaneDialog);
    }

    if (laneDialog) {
        laneDialog.addEventListener('click', (event) => {
            if (event.target === laneDialog) {
                closeLaneDialog();
            }
        });
    }

    if (targetAddClose) {
        targetAddClose.addEventListener('click', closeTargetAddDialog);
    }

    if (targetAddDialog) {
        targetAddDialog.addEventListener('click', (event) => {
            if (event.target === targetAddDialog) {
                closeTargetAddDialog();
            }
        });
    }

    const modalDropzone = document.querySelector('[data-dropzone-modal]');
    if (modalDropzone instanceof HTMLElement) {
        const fileInput = modalDropzone.querySelector('input[type="file"]');
        const preview = modalDropzone.querySelector('.dropzone-preview');
        const previewImage = modalDropzone.querySelector('.dropzone-preview img');
        const previewName = modalDropzone.querySelector('.dropzone-filename');
        const content = modalDropzone.querySelector('.dropzone-content');

        const updateModalPreview = (file) => {
            if (!preview || !previewImage || !previewName || !content) {
                return;
            }

            previewImage.src = URL.createObjectURL(file);
            previewImage.onload = () => URL.revokeObjectURL(previewImage.src);
            previewName.textContent = file.name;
            preview.hidden = false;
            content.hidden = true;
        };

        const resetModalPreview = () => {
            if (!preview || !previewImage || !previewName || !content) {
                return;
            }

            preview.hidden = true;
            content.hidden = false;
            previewImage.src = '';
            previewName.textContent = '';
        };

        modalDropzone.addEventListener('dragenter', (event) => {
            event.preventDefault();
            modalDropzone.classList.add('is-dragging');
        });

        modalDropzone.addEventListener('dragover', (event) => {
            event.preventDefault();
            modalDropzone.classList.add('is-dragging');
        });

        modalDropzone.addEventListener('dragleave', () => {
            modalDropzone.classList.remove('is-dragging');
        });

        modalDropzone.addEventListener('drop', (event) => {
            event.preventDefault();
            modalDropzone.classList.remove('is-dragging');
            if (!fileInput) {
                return;
            }

            const [file] = event.dataTransfer.files;
            if (!file) {
                resetModalPreview();
                return;
            }

            fileInput.files = event.dataTransfer.files;
            updateModalPreview(file);
        });

        if (fileInput) {
            fileInput.addEventListener('change', () => {
                const file = fileInput.files && fileInput.files[0];
                if (!file) {
                    resetModalPreview();
                    return;
                }

                updateModalPreview(file);
            });
        }
    }

    const refreshIconSelect = (nativeSelect) => {
        if (!(nativeSelect instanceof HTMLSelectElement)) {
            return;
        }

        const wrapper = nativeSelect.closest('[data-icon-select]');
        if (!wrapper) {
            return;
        }

        const trigger = wrapper.querySelector('.icon-select__trigger');
        const triggerIcon = trigger?.querySelector('.icon-select__icon');
        const triggerLabel = trigger?.querySelector('.icon-select__label');
        const options = Array.from(wrapper.querySelectorAll('.icon-select__option'));
        if (!trigger || options.length === 0) {
            return;
        }

        const value = nativeSelect.value;
        const match = options.find((option) => (option.dataset.value ?? '') === value) ?? options[0];
        const optionIcon = match.querySelector('.icon-select__icon');
        const optionLabel = match.querySelector('.icon-select__label');

        if (triggerIcon && optionIcon) {
            triggerIcon.innerHTML = optionIcon.innerHTML;
        }
        if (triggerLabel && optionLabel) {
            triggerLabel.textContent = optionLabel.textContent ?? '';
        }

        options.forEach((option) => {
            option.setAttribute('aria-selected', option === match ? 'true' : 'false');
        });
    };

    iconSelects.forEach((wrapper) => {
        if (!(wrapper instanceof HTMLElement)) {
            return;
        }

        const nativeSelect = wrapper.querySelector('select');
        const trigger = wrapper.querySelector('.icon-select__trigger');
        const options = Array.from(wrapper.querySelectorAll('.icon-select__option'));

        if (!(nativeSelect instanceof HTMLSelectElement) || !(trigger instanceof HTMLButtonElement)) {
            return;
        }

        const close = () => {
            wrapper.classList.remove('is-open');
            trigger.setAttribute('aria-expanded', 'false');
        };

        const open = () => {
            wrapper.classList.add('is-open');
            trigger.setAttribute('aria-expanded', 'true');
        };

        trigger.addEventListener('click', (event) => {
            event.preventDefault();
            if (wrapper.classList.contains('is-open')) {
                close();
            } else {
                open();
            }
        });

        options.forEach((option) => {
            option.addEventListener('click', () => {
                const value = option.dataset.value ?? '';
                nativeSelect.value = value;
                nativeSelect.dispatchEvent(new Event('change', { bubbles: true }));
                refreshIconSelect(nativeSelect);
                close();
            });
        });

        document.addEventListener('click', (event) => {
            const target = event.target;
            if (!(target instanceof Node) || !wrapper.contains(target)) {
                close();
            }
        });

        nativeSelect.addEventListener('change', () => refreshIconSelect(nativeSelect));
        refreshIconSelect(nativeSelect);
    });

    const total = rows.length;
    const update = () => {
        if (!input || !select) {
            return;
        }

        const term = input.value.trim().toLowerCase();
        const type = select.value;
        let visible = 0;

        rows.forEach((row) => {
            const name = row.dataset.name || '';
            const rowType = row.dataset.type || '';
            const matchesName = term === '' || name.includes(term);
            const matchesType = type === '' || rowType === type;
            const show = matchesName && matchesType;
            row.style.display = show ? '' : 'none';
            if (show) {
                visible += 1;
            }
        });

        if (countEl) {
            const hasFilter = term !== '' || type !== '';
            if (!hasFilter || total === 0 || visible === total) {
                countEl.textContent = '';
            } else {
                countEl.textContent = `Showing ${visible} of ${total}`;
            }
        }

        if (emptyEl) {
            emptyEl.style.display = total > 0 && visible === 0 ? '' : 'none';
        }
    };

        if (input && select && reset) {
            input.addEventListener('input', update);
            select.addEventListener('change', update);
            reset.addEventListener('click', () => {
                input.value = '';
                select.value = '';
                update();
                refreshIconSelect(select);
            });
            update();
        }
})();
</script>
{% endblock %}
