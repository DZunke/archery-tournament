{% extends 'base.html.twig' %}

{% block title %}{{ archeryGround.name }} · Archery Ground{% endblock %}

{% set defaultTargetType = targetTypes|first %}

{% block body %}
<section class="page-header">
    <div>
        <h1>{{ archeryGround.name }}</h1>
        <div class="page-meta">
            <span class="meta-item">
                {{ ux_icon('lucide:hash', {class: 'icon'}) }}
                <span>{{ archeryGround.id }}</span>
            </span>
        </div>
    </div>
    <div class="inline-actions">
        <form method="post" action="{{ path('archery_ground_rename', {id: archeryGround.id}) }}" class="inline-form">
            <input type="hidden" name="_token" value="{{ csrf_token('archery_ground_rename_' ~ archeryGround.id) }}">
            <input type="text" name="name" value="{{ archeryGround.name }}" aria-label="Rename archery ground">
            <button class="button" type="submit">
                {{ ux_icon('lucide:pencil', {class: 'icon'}) }}
                <span>Rename</span>
            </button>
        </form>
        <form method="post" action="{{ path('archery_ground_delete', {id: archeryGround.id}) }}" onsubmit="return confirm('Delete this archery ground?')">
            <input type="hidden" name="_token" value="{{ csrf_token('archery_ground_delete_' ~ archeryGround.id) }}">
            <button class="button danger" type="submit">
                {{ ux_icon('lucide:trash-2', {class: 'icon'}) }}
                <span>Delete</span>
            </button>
        </form>
    </div>
</section>

<div class="split">
    <section class="panel">
        <div class="panel-header">
            <h2>Lanes <span class="badge">{{ archeryGround.shootingLanes|length }}</span></h2>
            <button
                class="button js-add-lane"
                type="button"
                data-action="{{ path('archery_ground_add_lane', {id: archeryGround.id}) }}"
                data-token="{{ csrf_token('archery_ground_add_lane_' ~ archeryGround.id) }}"
            >
                {{ ux_icon('lucide:plus', {class: 'icon'}) }}
                <span>Add lane</span>
            </button>
        </div>

        <div class="filter-bar" role="search" aria-label="Filter lanes">
            <label class="field">
                <span>Search</span>
                <input type="text" id="lane-filter" placeholder="Search by name">
            </label>
            <label class="field">
                <span>Type</span>
                <select id="lane-type-filter">
                    <option value="">All lanes</option>
                    <option value="competition">Competition</option>
                    <option value="training">Training only</option>
                </select>
            </label>
            <button class="button ghost" type="button" id="lane-filter-reset">
                {{ ux_icon('lucide:rotate-ccw', {class: 'icon'}) }}
                <span>Reset</span>
            </button>
        </div>
        <p class="filter-count" id="lane-filter-count"></p>

        <div class="table lanes">
            <div class="table-row table-head">
                <div>Name</div>
                <div>Max Distance</div>
                <div></div>
            </div>
            {% for lane in archeryGround.shootingLanes %}
                {% set laneUsages = tournamentUsages.tournamentsUsingLane(lane.id) %}
                {% set laneInUse = laneUsages|length > 0 %}
                <div class="table-row lane-row" data-name="{{ lane.name|lower }}" data-training="{{ lane.forTrainingOnly ? 'training' : 'competition' }}">
                    <div class="lane-name">
                        <span class="card-label">{{ lane.name }}</span>
                        {% if lane.forTrainingOnly %}
                            <span class="lane-badge" title="For training purposes only">{{ ux_icon('lucide:graduation-cap', {class: 'icon icon-sm'}) }}</span>
                        {% endif %}
                        {% if lane.notes %}
                            <span class="lane-badge" title="{{ lane.notes }}">{{ ux_icon('lucide:message-square-text', {class: 'icon icon-sm'}) }}</span>
                        {% endif %}
                        {% if laneInUse %}
                            <span class="lane-badge in-use" title="Used in {{ laneUsages|length }} tournament(s)">{{ ux_icon('lucide:trophy', {class: 'icon icon-sm'}) }}</span>
                        {% endif %}
                    </div>
                    <div>{{ lane.maxDistance }} m</div>
                    <div class="table-actions">
                        <button
                            class="icon-button js-edit-lane"
                            type="button"
                            aria-label="Edit lane {{ lane.name }}"
                            data-action="{{ path('archery_ground_update_lane', {id: archeryGround.id, laneId: lane.id}) }}"
                            data-token="{{ csrf_token('archery_ground_update_lane_' ~ archeryGround.id ~ '_' ~ lane.id) }}"
                            data-name="{{ lane.name }}"
                            data-distance="{{ lane.maxDistance }}"
                            data-for-training-only="{{ lane.forTrainingOnly ? '1' : '0' }}"
                            data-notes="{{ lane.notes }}"
                            data-in-use="{{ laneInUse ? '1' : '0' }}"
                            data-usages="{{ laneUsages|map(u => u.name)|join(', ') }}"
                        >
                            {{ ux_icon('lucide:pencil', {class: 'icon'}) }}
                            <span class="sr-only">Edit</span>
                        </button>
                        {% if laneInUse %}
                            <button class="icon-button danger" type="button" disabled aria-label="Cannot remove lane {{ lane.name }} - in use" title="Cannot remove: used in tournament(s)">
                                {{ ux_icon('lucide:trash-2', {class: 'icon'}) }}
                                <span class="sr-only">Cannot remove</span>
                            </button>
                        {% else %}
                            <form method="post" action="{{ path('archery_ground_delete_lane', {id: archeryGround.id, laneId: lane.id}) }}" onsubmit="return confirm('Remove this lane?')">
                                <input type="hidden" name="_token" value="{{ csrf_token('archery_ground_delete_lane_' ~ archeryGround.id ~ '_' ~ lane.id) }}">
                                <button class="icon-button danger" type="submit" aria-label="Remove lane {{ lane.name }}">
                                    {{ ux_icon('lucide:trash-2', {class: 'icon'}) }}
                                    <span class="sr-only">Remove</span>
                                </button>
                            </form>
                        {% endif %}
                    </div>
                </div>
            {% else %}
                <div class="table-row empty">
                    <div>No lanes yet.</div>
                </div>
            {% endfor %}
            <div class="table-row empty lane-empty" style="display: none;">
                <div>No lanes match your filter.</div>
            </div>
        </div>
    </section>

    <section class="panel">
        <div class="panel-header">
            <h2>Targets <span class="badge">{{ archeryGround.targetStorage|length }}</span></h2>
            <button
                class="button js-add-target"
                type="button"
                data-action="{{ path('archery_ground_add_target', {id: archeryGround.id}) }}"
                data-token="{{ csrf_token('archery_ground_add_target_' ~ archeryGround.id) }}"
            >
                {{ ux_icon('lucide:plus', {class: 'icon'}) }}
                <span>Add target</span>
            </button>
            <a href="{{ path('archery_ground_print_targets', {id: archeryGround.id}) }}" class="button ghost" target="_blank" aria-label="Print targets">
                {{ ux_icon('lucide:printer', {class: 'icon'}) }}
            </a>
        </div>

        <div class="filter-bar" role="search" aria-label="Filter targets">
            <label class="field">
                <span>Search</span>
                <input type="text" id="target-filter" placeholder="Search by name">
            </label>
            <label class="field">
                <span>Type</span>
                <div class="icon-select" data-icon-select>
                    <select id="target-type-filter" class="icon-select__native">
                        <option value="">All types</option>
                        {% for type in targetTypes %}
                            <option value="{{ type.value }}">{{ target_type_label(type.value) }}</option>
                        {% endfor %}
                    </select>
                    <button class="icon-select__trigger" type="button" aria-haspopup="listbox" aria-expanded="false">
                        <span class="icon-select__icon">
                            {{ ux_icon('lucide:layers', {class: 'icon'}) }}
                        </span>
                        <span class="icon-select__label">All types</span>
                        {{ ux_icon('lucide:chevron-down', {class: 'icon icon-select__chevron'}) }}
                    </button>
                    <div class="icon-select__options" role="listbox">
                        <button type="button" class="icon-select__option" data-value="" role="option" aria-selected="true">
                            <span class="icon-select__icon">
                                {{ ux_icon('lucide:layers', {class: 'icon'}) }}
                            </span>
                            <span class="icon-select__label">All types</span>
                        </button>
                        {% for type in targetTypes %}
                            <button type="button" class="icon-select__option" data-value="{{ type.value }}" role="option">
                                <span class="icon-select__icon">
                                    {{ ux_icon(target_type_icon(type.value), {class: 'icon'}) }}
                                </span>
                                <span class="icon-select__label">{{ target_type_label(type.value) }}</span>
                            </button>
                        {% endfor %}
                    </div>
                </div>
            </label>
            <label class="field">
                <span>Usage</span>
                <select id="target-usage-filter">
                    <option value="">All targets</option>
                    <option value="competition">Competition</option>
                    <option value="training">Training only</option>
                </select>
            </label>
            <button class="button ghost" type="button" id="target-filter-reset">
                {{ ux_icon('lucide:rotate-ccw', {class: 'icon'}) }}
                <span>Reset</span>
            </button>
        </div>
        <p class="filter-count" id="target-filter-count"></p>

        <div class="table targets">
            <div class="table-row table-head">
                <div>Image</div>
                <div>Target</div>
                <div></div>
            </div>
            {% for target in archeryGround.targetStorage %}
                {% set targetUsages = tournamentUsages.tournamentsUsingTarget(target.id) %}
                {% set targetInUse = targetUsages|length > 0 %}
                <div class="table-row target-row" data-name="{{ target.name|lower }}" data-type="{{ target.type.value }}" data-training="{{ target.forTrainingOnly ? 'training' : 'competition' }}">
                    <div class="image-cell">
                        {% if target.image %}
                            <div class="image-preview" tabindex="0" role="button" aria-label="Preview {{ target.name }}">
                                <img src="{{ target.image }}" alt="{{ target.name }}">
                                <div class="preview-pop">
                                    <img src="{{ target.image }}" alt="{{ target.name }} preview">
                                </div>
                            </div>
                        {% else %}
                            -
                        {% endif %}
                    </div>
                    <div class="target-info">
                        <div class="target-name">
                            <span class="type-pill type-pill--inline" title="{{ target_type_label(target.type.value) }}">
                                {{ ux_icon(target_type_icon(target.type.value), {class: 'icon'}) }}
                            </span>
                            <span class="card-label">{{ target.name }}</span>
                            {% if target.forTrainingOnly %}
                                <span class="lane-badge" title="For training purposes only">{{ ux_icon('lucide:graduation-cap', {class: 'icon icon-sm'}) }}</span>
                            {% endif %}
                            {% if target.notes %}
                                <span class="lane-badge" title="{{ target.notes }}">{{ ux_icon('lucide:message-square-text', {class: 'icon icon-sm'}) }}</span>
                            {% endif %}
                            {% if targetInUse %}
                                <span class="lane-badge in-use" title="Used in {{ targetUsages|length }} tournament(s)">{{ ux_icon('lucide:trophy', {class: 'icon icon-sm'}) }}</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="table-actions target-actions">
                        <button
                            class="icon-button js-edit-target"
                            type="button"
                            aria-label="Edit target {{ target.name }}"
                            data-action="{{ path('archery_ground_update_target', {id: archeryGround.id, targetId: target.id}) }}"
                            data-token="{{ csrf_token('archery_ground_update_target_' ~ archeryGround.id ~ '_' ~ target.id) }}"
                            data-name="{{ target.name }}"
                            data-type="{{ target.type.value }}"
                            data-image="{{ target.image }}"
                            data-for-training-only="{{ target.forTrainingOnly ? '1' : '0' }}"
                            data-notes="{{ target.notes }}"
                            data-target-zone-size="{{ target.targetZoneSize }}"
                            data-in-use="{{ targetInUse ? '1' : '0' }}"
                            data-usages="{{ targetUsages|map(u => u.name)|join(', ') }}"
                        >
                            {{ ux_icon('lucide:pencil', {class: 'icon'}) }}
                            <span class="sr-only">Edit</span>
                        </button>
                        {% if targetInUse %}
                            <button class="icon-button danger" type="button" disabled aria-label="Cannot remove target {{ target.name }} - in use" title="Cannot remove: used in tournament(s)">
                                {{ ux_icon('lucide:trash-2', {class: 'icon'}) }}
                                <span class="sr-only">Cannot remove</span>
                            </button>
                        {% else %}
                            <form method="post" action="{{ path('archery_ground_delete_target', {id: archeryGround.id, targetId: target.id}) }}" onsubmit="return confirm('Remove this target?')">
                                <input type="hidden" name="_token" value="{{ csrf_token('archery_ground_delete_target_' ~ archeryGround.id ~ '_' ~ target.id) }}">
                                <button class="icon-button danger" type="submit" aria-label="Remove target {{ target.name }}">
                                    {{ ux_icon('lucide:trash-2', {class: 'icon'}) }}
                                    <span class="sr-only">Remove</span>
                                </button>
                            </form>
                        {% endif %}
                    </div>
                </div>
            {% else %}
                <div class="table-row empty">
                    <div>No targets yet.</div>
                </div>
            {% endfor %}
            <div class="table-row empty target-empty" style="display: none;">
                <div>No targets match your filter.</div>
            </div>
        </div>
    </section>
</div>

<section class="panel panel-spaced">
    <div class="panel-header">
        <h2>Tournaments</h2>
        <span class="badge">{{ tournaments|default([])|length }}</span>
    </div>
    <p class="muted">Create and manage tournaments for this archery ground. Upcoming tournaments are shown first.</p>
    <div class="inline-actions">
        <a class="button" href="{{ path('tournament_new', {archery_ground_id: archeryGround.id, mode: 'auto'}) }}">
            {{ ux_icon('lucide:sparkles', {class: 'icon'}) }}
            <span>Auto-generate tournament</span>
        </a>
        <a class="button ghost" href="{{ path('tournament_new', {archery_ground_id: archeryGround.id, mode: 'manual'}) }}">
            {{ ux_icon('lucide:list-plus', {class: 'icon'}) }}
            <span>Manual tournament</span>
        </a>
    </div>

    {% set today = "now"|date('Y-m-d') %}
    {% set soon = "now"|date_modify('+14 days')|date('Y-m-d') %}

    {% if nextTournament is defined and nextTournament %}
        {% set nextDate = nextTournament.eventDate|date('Y-m-d') %}
        {% if nextDate < today %}
            {% set nextStatus = 'past' %}
        {% elseif nextDate == today %}
            {% set nextStatus = 'today' %}
        {% elseif nextDate <= soon %}
            {% set nextStatus = 'upcoming' %}
        {% else %}
            {% set nextStatus = 'future' %}
        {% endif %}
        <div class="next-tournament">
            <div>
                <strong>Next tournament:</strong> {{ nextTournament.name }} · {{ nextTournament.eventDate|date('Y-m-d') }}
                <span class="status-pill {{ nextStatus }}">{{ nextStatus|capitalize }}</span>
            </div>
            <div class="next-tournament__actions">
                <a class="button ghost" href="{{ path('tournament_show', {id: nextTournament.id}) }}">
                    {{ ux_icon('lucide:settings', {class: 'icon'}) }}
                    <span>Manage</span>
                </a>
                <a class="button ghost" href="{{ path('tournament_view', {id: nextTournament.id}) }}">
                    {{ ux_icon('lucide:eye', {class: 'icon'}) }}
                    <span>View</span>
                </a>
                <a class="button ghost" href="{{ path('tournament_print', {id: nextTournament.id}) }}">
                    {{ ux_icon('lucide:printer', {class: 'icon'}) }}
                    <span>Print</span>
                </a>
            </div>
        </div>
    {% endif %}

    <div class="grid tournament-grid">
        {% for tournament in tournaments|default([]) %}
            {% set eventDate = tournament.eventDate|date('Y-m-d') %}
            {% if eventDate < today %}
                {% set status = 'past' %}
            {% elseif eventDate == today %}
                {% set status = 'today' %}
            {% elseif eventDate <= soon %}
                {% set status = 'upcoming' %}
            {% else %}
                {% set status = 'future' %}
            {% endif %}
            <article class="card tournament-card tournament-card--{{ status }}">
                <div class="tournament-card__top">
                    <div>
                        <h2>{{ tournament.name }}</h2>
                        <p class="muted">{{ tournament.eventDate|date('Y-m-d') }}</p>
                    </div>
                    <div class="tournament-card__tags">
                        <span class="status-pill {{ status }}">{{ status|capitalize }}</span>
                        <span class="badge">{{ tournament.ruleset.value }}</span>
                    </div>
                </div>
                <div class="tournament-card__stats">
                    <div class="tournament-card__stat">
                        <strong>{{ tournament.numberOfTargets }}</strong>
                        <span>Targets</span>
                    </div>
                    <div class="tournament-card__stat">
                        <strong>{{ tournament.targets|length }}</strong>
                        <span>Assigned</span>
                    </div>
                </div>
                <div class="tournament-card__actions">
                    <a class="button ghost" href="{{ path('tournament_show', {id: tournament.id}) }}">
                        {{ ux_icon('lucide:settings', {class: 'icon'}) }}
                        <span>Manage</span>
                    </a>
                    <a class="button ghost" href="{{ path('tournament_view', {id: tournament.id}) }}">
                        {{ ux_icon('lucide:eye', {class: 'icon'}) }}
                        <span>View</span>
                    </a>
                    <a class="button ghost" href="{{ path('tournament_print', {id: tournament.id}) }}">
                        {{ ux_icon('lucide:printer', {class: 'icon'}) }}
                        <span>Print</span>
                    </a>
                    <form method="post" action="{{ path('tournament_delete', {id: tournament.id}) }}" onsubmit="return confirm('Delete this tournament?')">
                        <input type="hidden" name="_token" value="{{ csrf_token('tournament_delete_' ~ tournament.id) }}">
                        <button class="button ghost danger" type="submit">
                            {{ ux_icon('lucide:trash-2', {class: 'icon'}) }}
                            <span>Delete</span>
                        </button>
                    </form>
                </div>
            </article>
        {% else %}
            <div class="empty-state">
                <h2>No tournaments yet</h2>
                <p>Create your first tournament for this archery ground.</p>
                <a class="button" href="{{ path('tournament_new', {archery_ground_id: archeryGround.id}) }}">
                    {{ ux_icon('lucide:trophy', {class: 'icon'}) }}
                    <span>Create tournament</span>
                </a>
            </div>
        {% endfor %}
    </div>
</section>

{% include 'components/_attachment_section.html.twig' with {
    attachments: archeryGround.attachments,
    add_route: 'archery_ground_add_attachment',
    delete_route: 'archery_ground_delete_attachment',
    entity_id: archeryGround.id,
    csrf_add_prefix: 'archery_ground_add_attachment_',
    csrf_delete_prefix: 'archery_ground_delete_attachment_',
    description: 'Upload PDF documents or images to document your archery ground, such as lane overviews or maps.'
} %}

<dialog id="lane-dialog" class="modal">
    <form method="post" id="lane-form" class="modal__body">
        <input type="hidden" name="_token" id="lane-token">
        <h3 id="lane-dialog-title">Edit lane <span id="lane-name-label"></span></h3>
        <div id="lane-usage-info" class="usage-info" hidden>
            <div class="usage-info__header">
                {{ ux_icon('lucide:info', {class: 'icon'}) }}
                <span>This lane is used in tournaments</span>
            </div>
            <p class="usage-info__detail">Editing may affect: <strong id="lane-usage-list"></strong></p>
        </div>
        <label class="field">
            <span>Lane name</span>
            <input type="text" name="name" id="lane-name-input" placeholder="Lane 1" required>
        </label>
        <label class="field">
            <span>Max distance (m)</span>
            <input type="number" name="max_distance" id="lane-distance-input" min="0.1" step="0.1" placeholder="30" required>
        </label>
        <label class="field checkbox">
            <input type="checkbox" name="for_training_only" id="lane-training-input" value="1">
            <span>For training purposes only</span>
        </label>
        <label class="field">
            <span>Notes</span>
            <textarea name="notes" id="lane-notes-input" rows="3" placeholder="Optional notes about this lane"></textarea>
        </label>
        <div class="modal__actions">
            <button class="button ghost" type="button" data-lane-close>Cancel</button>
            <button class="button" type="submit" id="lane-submit-btn">Save changes</button>
        </div>
    </form>
</dialog>

<dialog id="target-add-dialog" class="modal">
    <form method="post" enctype="multipart/form-data" id="target-add-form" class="modal__body">
        <input type="hidden" name="_token" id="target-add-token">
        <h3>Add target</h3>
        <fieldset class="field-group">
            <legend>Target Classification</legend>
            <label class="field">
                <span>Zone size <span class="muted">(mm, optional)</span></span>
                <input type="number" name="target_zone_size" id="target-add-zone-size" min="1" placeholder="e.g., 200">
                <small class="field-hint">When provided, the type is auto-selected based on the ruleset.</small>
                <span class="field-error" id="target-add-zone-size-error"></span>
            </label>
            <label class="field">
                <span>Type</span>
                <div class="icon-select" data-icon-select>
                    <select name="type" id="target-add-type" class="icon-select__native" required>
                        {% for type in targetTypes %}
                            <option value="{{ type.value }}">{{ target_type_label(type.value) }}</option>
                        {% endfor %}
                    </select>
                    {% if defaultTargetType %}
                        <button class="icon-select__trigger" type="button" aria-haspopup="listbox" aria-expanded="false">
                            <span class="icon-select__icon">
                                {{ ux_icon(target_type_icon(defaultTargetType.value), {class: 'icon'}) }}
                            </span>
                            <span class="icon-select__label">{{ target_type_label(defaultTargetType.value) }}</span>
                            {{ ux_icon('lucide:chevron-down', {class: 'icon icon-select__chevron'}) }}
                        </button>
                        <div class="icon-select__options" role="listbox">
                            {% for type in targetTypes %}
                                <button
                                    type="button"
                                    class="icon-select__option"
                                    data-value="{{ type.value }}"
                                    data-icon="{{ target_type_icon(type.value) }}"
                                    data-label="{{ target_type_label(type.value) }}"
                                    role="option"
                                    aria-selected="{{ loop.first ? 'true' : 'false' }}"
                                >
                                    <span class="icon-select__icon">
                                        {{ ux_icon(target_type_icon(type.value), {class: 'icon'}) }}
                                    </span>
                                    <span class="icon-select__label">{{ target_type_label(type.value) }}</span>
                                </button>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                <span class="field-error" id="target-add-type-error"></span>
            </label>
        </fieldset>
        <label class="field">
            <span>Target name</span>
            <input type="text" name="name" id="target-add-name" placeholder="Deer" required>
        </label>
        <label class="field">
            <span>Target image</span>
            <div class="dropzone" data-dropzone-modal data-max-size="20971520" data-allowed-types="image/jpeg,image/png,image/webp,image/gif">
                <input type="file" name="image" accept="image/*" required>
                <div class="dropzone-content">
                    <strong>Drag & drop</strong> or click to upload
                    <span class="dropzone-hint">PNG, JPG, WEBP, or GIF (max 20 MB)</span>
                </div>
                <div class="dropzone-preview" hidden>
                    <img src="" alt="Selected target preview">
                    <div>
                        <div class="dropzone-filename"></div>
                        <div class="dropzone-hint">Drop a new image to replace</div>
                    </div>
                </div>
                <div class="dropzone-error" hidden></div>
            </div>
        </label>
        <label class="field checkbox">
            <input type="checkbox" name="for_training_only" id="target-add-for-training-only">
            <span>For training purposes only</span>
        </label>
        <label class="field">
            <span>Notes</span>
            <textarea name="notes" id="target-add-notes" rows="3" placeholder="Optional notes about this target"></textarea>
        </label>
        <div class="modal__actions">
            <button class="button ghost" type="button" data-target-add-close>Cancel</button>
            <button class="button" type="submit">Add target</button>
        </div>
    </form>
</dialog>

<dialog id="target-edit-dialog" class="modal">
    <form method="post" enctype="multipart/form-data" id="target-edit-form" class="modal__body">
        <input type="hidden" name="_token" id="target-edit-token">
        <h3>Edit target <span id="target-edit-title"></span></h3>
        <div id="target-usage-info" class="usage-info" hidden>
            <div class="usage-info__header">
                {{ ux_icon('lucide:info', {class: 'icon'}) }}
                <span>This target is used in tournaments</span>
            </div>
            <p class="usage-info__detail">Editing may affect: <strong id="target-usage-list"></strong></p>
        </div>
        <fieldset class="field-group">
            <legend>Target Classification</legend>
            <label class="field">
                <span>Zone size <span class="muted">(mm, optional)</span></span>
                <input type="number" name="target_zone_size" id="target-edit-zone-size" min="1" placeholder="e.g., 200">
                <small class="field-hint">When provided, the type is auto-selected based on the ruleset.</small>
                <span class="field-error" id="target-edit-zone-size-error"></span>
            </label>
            <label class="field">
                <span>Type</span>
                <div class="icon-select" data-icon-select>
                    <select name="type" id="target-edit-type" class="icon-select__native" required>
                        {% for type in targetTypes %}
                            <option value="{{ type.value }}">{{ target_type_label(type.value) }}</option>
                        {% endfor %}
                    </select>
                    {% if defaultTargetType %}
                        <button class="icon-select__trigger" type="button" aria-haspopup="listbox" aria-expanded="false" id="target-edit-type-trigger">
                            <span class="icon-select__icon" id="target-edit-type-icon">
                                {{ ux_icon(target_type_icon(defaultTargetType.value), {class: 'icon'}) }}
                            </span>
                            <span class="icon-select__label" id="target-edit-type-label">{{ target_type_label(defaultTargetType.value) }}</span>
                            {{ ux_icon('lucide:chevron-down', {class: 'icon icon-select__chevron'}) }}
                        </button>
                        <div class="icon-select__options" role="listbox">
                            {% for type in targetTypes %}
                                <button
                                    type="button"
                                    class="icon-select__option"
                                    data-value="{{ type.value }}"
                                    data-icon="{{ target_type_icon(type.value) }}"
                                    data-label="{{ target_type_label(type.value) }}"
                                    role="option"
                                    aria-selected="{{ loop.first ? 'true' : 'false' }}"
                                >
                                    <span class="icon-select__icon">
                                        {{ ux_icon(target_type_icon(type.value), {class: 'icon'}) }}
                                    </span>
                                    <span class="icon-select__label">{{ target_type_label(type.value) }}</span>
                                </button>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                <span class="field-error" id="target-edit-type-error"></span>
            </label>
        </fieldset>
        <label class="field">
            <span>Target name</span>
            <input type="text" name="name" id="target-edit-name" placeholder="Deer" required>
        </label>
        <label class="field">
            <span>Target image <span class="muted">(optional, leave empty to keep current)</span></span>
            <div class="modal__preview" id="target-edit-preview-wrap" hidden>
                <img id="target-edit-preview" alt="">
            </div>
            <input type="file" name="image" id="target-edit-image" accept="image/*">
            <span class="field-error" id="target-edit-image-error"></span>
        </label>
        <label class="field checkbox">
            <input type="checkbox" name="for_training_only" id="target-edit-for-training-only">
            <span>For training purposes only</span>
        </label>
        <label class="field">
            <span>Notes</span>
            <textarea name="notes" id="target-edit-notes" rows="3" placeholder="Optional notes about this target"></textarea>
        </label>
        <div class="modal__actions">
            <button class="button ghost" type="button" data-target-edit-close>Cancel</button>
            <button class="button" type="submit">Save changes</button>
        </div>
    </form>
</dialog>

{% include 'components/_attachment_dialog.html.twig' %}

<script>
(() => {
    const input = document.getElementById('target-filter');
    const select = document.getElementById('target-type-filter');
    const reset = document.getElementById('target-filter-reset');
    const rows = Array.from(document.querySelectorAll('.target-row'));
    const countEl = document.getElementById('target-filter-count');
    const emptyEl = document.querySelector('.target-empty');
    const iconSelects = Array.from(document.querySelectorAll('[data-icon-select]'));

    // Lane filter elements
    const laneFilterInput = document.getElementById('lane-filter');
    const laneFilterSelect = document.getElementById('lane-type-filter');
    const laneFilterReset = document.getElementById('lane-filter-reset');
    const laneRows = Array.from(document.querySelectorAll('.lane-row'));
    const laneCountEl = document.getElementById('lane-filter-count');
    const laneEmptyEl = document.querySelector('.lane-empty');

    const dialog = document.getElementById('target-edit-dialog');
    const dialogForm = document.getElementById('target-edit-form');
    const dialogToken = document.getElementById('target-edit-token');
    const dialogTitle = document.getElementById('target-edit-title');
    const dialogName = document.getElementById('target-edit-name');
    const dialogType = document.getElementById('target-edit-type');
    const dialogTypeTrigger = document.getElementById('target-edit-type-trigger');
    const dialogTypeIcon = document.getElementById('target-edit-type-icon');
    const dialogTypeLabel = document.getElementById('target-edit-type-label');
    const dialogPreview = document.getElementById('target-edit-preview');
    const dialogPreviewWrap = document.getElementById('target-edit-preview-wrap');
    const dialogImageInput = document.getElementById('target-edit-image');
    const dialogTrainingInput = document.getElementById('target-edit-for-training-only');
    const dialogNotesInput = document.getElementById('target-edit-notes');
    const dialogZoneSizeInput = document.getElementById('target-edit-zone-size');
    const dialogClose = document.querySelector('[data-target-edit-close]');
    const laneDialog = document.getElementById('lane-dialog');
    const laneForm = document.getElementById('lane-form');
    const laneToken = document.getElementById('lane-token');
    const laneDialogTitle = document.getElementById('lane-dialog-title');
    const laneNameLabel = document.getElementById('lane-name-label');
    const laneNameInput = document.getElementById('lane-name-input');
    const laneDistanceInput = document.getElementById('lane-distance-input');
    const laneTrainingInput = document.getElementById('lane-training-input');
    const laneNotesInput = document.getElementById('lane-notes-input');
    const laneSubmitBtn = document.getElementById('lane-submit-btn');
    const laneClose = document.querySelector('[data-lane-close]');
    const laneUsageInfo = document.getElementById('lane-usage-info');
    const laneUsageList = document.getElementById('lane-usage-list');

    const targetUsageInfo = document.getElementById('target-usage-info');
    const targetUsageList = document.getElementById('target-usage-list');

    const targetAddDialog = document.getElementById('target-add-dialog');
    const targetAddForm = document.getElementById('target-add-form');
    const targetAddToken = document.getElementById('target-add-token');
    const targetAddName = document.getElementById('target-add-name');
    const targetAddTrainingInput = document.getElementById('target-add-for-training-only');
    const targetAddNotesInput = document.getElementById('target-add-notes');
    const targetAddZoneSizeInput = document.getElementById('target-add-zone-size');
    const targetAddType = document.getElementById('target-add-type');
    const targetAddClose = document.querySelector('[data-target-add-close]');

    // Zone size to target type conversion
    // Group 1: > 250mm, Group 2: 201-250mm, Group 3: 150-200mm, Group 4: < 150mm
    const typeLabels = {
        'animal_group_1': 'Group 1',
        'animal_group_2': 'Group 2',
        'animal_group_3': 'Group 3',
        'animal_group_4': 'Group 4'
    };

    const typeRanges = {
        'animal_group_1': '> 250mm',
        'animal_group_2': '201-250mm',
        'animal_group_3': '150-200mm',
        'animal_group_4': '< 150mm'
    };

    const getTypeFromZoneSize = (zoneSizeInMm) => {
        if (zoneSizeInMm > 250) return 'animal_group_1';
        if (zoneSizeInMm >= 201) return 'animal_group_2';
        if (zoneSizeInMm >= 150) return 'animal_group_3';
        return 'animal_group_4';
    };

    const getTypeLabel = (typeValue) => typeLabels[typeValue] || typeValue;
    const getTypeRange = (typeValue) => typeRanges[typeValue] || '';

    const updateTypeFromZoneSize = (zoneSizeInput, typeSelect, selectContainer) => {
        const zoneSize = parseInt(zoneSizeInput.value, 10);
        if (isNaN(zoneSize) || zoneSize <= 0) {
            return;
        }

        const derivedType = getTypeFromZoneSize(zoneSize);
        typeSelect.value = derivedType;

        // Update the icon-select visual state
        if (selectContainer) {
            const trigger = selectContainer.querySelector('.icon-select__trigger');
            const iconEl = selectContainer.querySelector('.icon-select__icon');
            const labelEl = selectContainer.querySelector('.icon-select__label');
            const optionsContainer = selectContainer.querySelector('.icon-select__options');

            if (trigger && iconEl && labelEl && optionsContainer) {
                const options = optionsContainer.querySelectorAll('.icon-select__option');
                options.forEach(opt => {
                    const isSelected = opt.dataset.value === derivedType;
                    opt.setAttribute('aria-selected', isSelected ? 'true' : 'false');
                    if (isSelected) {
                        labelEl.textContent = opt.dataset.label || '';
                        const optIconEl = opt.querySelector('.icon-select__icon');
                        if (optIconEl) {
                            iconEl.innerHTML = optIconEl.innerHTML;
                        }
                    }
                });
            }
        }
    };

    // Event listeners for zone size changes
    if (targetAddZoneSizeInput && targetAddType) {
        const addDialogSelectContainer = targetAddDialog ? targetAddDialog.querySelector('[data-icon-select]') : null;
        targetAddZoneSizeInput.addEventListener('input', () => {
            updateTypeFromZoneSize(targetAddZoneSizeInput, targetAddType, addDialogSelectContainer);
        });
    }

    if (dialogZoneSizeInput && dialogType) {
        const editDialogSelectContainer = dialog ? dialog.querySelector('[data-icon-select]') : null;
        dialogZoneSizeInput.addEventListener('input', () => {
            updateTypeFromZoneSize(dialogZoneSizeInput, dialogType, editDialogSelectContainer);
            clearFieldError(dialogZoneSizeInput, 'target-edit-zone-size-error');
        });
    }

    // Validation helper functions
    const showFieldError = (input, errorId, message) => {
        const errorEl = document.getElementById(errorId);
        if (errorEl) {
            errorEl.textContent = message;
            errorEl.classList.add('is-visible');
        }
        if (input) {
            input.classList.add('is-invalid');
        }
    };

    const clearFieldError = (input, errorId) => {
        const errorEl = document.getElementById(errorId);
        if (errorEl) {
            errorEl.textContent = '';
            errorEl.classList.remove('is-visible');
        }
        if (input) {
            input.classList.remove('is-invalid');
        }
    };

    const validateZoneSizeAndType = (zoneSizeInput, typeInput, zoneSizeErrorId, typeErrorId) => {
        let isValid = true;

        // Clear previous errors
        clearFieldError(zoneSizeInput, zoneSizeErrorId);
        clearFieldError(typeInput, typeErrorId);

        const zoneSizeValue = zoneSizeInput ? zoneSizeInput.value.trim() : '';

        if (zoneSizeValue !== '') {
            const zoneSize = parseInt(zoneSizeValue, 10);

            if (isNaN(zoneSize) || zoneSize <= 0) {
                showFieldError(zoneSizeInput, zoneSizeErrorId, 'Zone size must be a positive number');
                isValid = false;
            } else {
                const derivedType = getTypeFromZoneSize(zoneSize);
                const selectedType = typeInput ? typeInput.value : '';

                if (selectedType !== derivedType) {
                    const derivedLabel = getTypeLabel(derivedType);
                    const derivedRange = getTypeRange(derivedType);
                    const message = `Zone size ${zoneSize}mm matches ${derivedLabel} (${derivedRange})`;
                    showFieldError(typeInput, typeErrorId, message);
                    isValid = false;
                }
            }
        }

        return isValid;
    };

    // Form validation on submit - Add Target Dialog
    if (targetAddForm) {
        targetAddForm.addEventListener('submit', (event) => {
            const isValid = validateZoneSizeAndType(
                targetAddZoneSizeInput,
                targetAddType,
                'target-add-zone-size-error',
                'target-add-type-error'
            );

            if (!isValid) {
                event.preventDefault();
            }
        });
    }

    // Form validation on submit - Edit Target Dialog
    if (dialogForm) {
        dialogForm.addEventListener('submit', (event) => {
            const isValid = validateZoneSizeAndType(
                dialogZoneSizeInput,
                dialogType,
                'target-edit-zone-size-error',
                'target-edit-type-error'
            );

            if (!isValid) {
                event.preventDefault();
            }
        });
    }

    // Clear errors on zone size input change for Add dialog
    if (targetAddZoneSizeInput) {
        targetAddZoneSizeInput.addEventListener('input', () => {
            clearFieldError(targetAddZoneSizeInput, 'target-add-zone-size-error');
            clearFieldError(targetAddType, 'target-add-type-error');
        });
    }

    const openDialog = (button) => {
        if (!dialog || !dialogForm || !dialogToken || !dialogTitle || !dialogName || !dialogType) {
            return;
        }

        dialogForm.setAttribute('action', button.dataset.action || '');
        dialogToken.value = button.dataset.token || '';
        dialogTitle.textContent = button.dataset.name || 'Target';
        dialogName.value = button.dataset.name || '';
        dialogType.value = button.dataset.type || '';

        // Update the icon-select visual state to match the current type
        const currentType = button.dataset.type || '';
        if (dialogTypeTrigger && dialogTypeIcon && dialogTypeLabel) {
            const optionsContainer = dialog.querySelector('.icon-select__options');
            if (optionsContainer) {
                const options = optionsContainer.querySelectorAll('.icon-select__option');
                options.forEach(opt => {
                    const isSelected = opt.dataset.value === currentType;
                    opt.setAttribute('aria-selected', isSelected ? 'true' : 'false');
                    if (isSelected) {
                        dialogTypeLabel.textContent = opt.dataset.label || '';
                        // Copy the icon HTML from the option
                        const iconEl = opt.querySelector('.icon-select__icon');
                        if (iconEl) {
                            dialogTypeIcon.innerHTML = iconEl.innerHTML;
                        }
                    }
                });
            }
        }

        if (dialogPreview && dialogPreviewWrap) {
            if (button.dataset.image) {
                dialogPreview.src = button.dataset.image;
                dialogPreviewWrap.hidden = false;
            } else {
                dialogPreview.src = '';
                dialogPreviewWrap.hidden = true;
            }
        }

        // Reset file input
        if (dialogImageInput) {
            dialogImageInput.value = '';
        }

        // Set training checkbox and notes
        if (dialogTrainingInput) {
            dialogTrainingInput.checked = button.dataset.forTrainingOnly === '1';
        }
        if (dialogNotesInput) {
            dialogNotesInput.value = button.dataset.notes || '';
        }

        // Set zone size
        if (dialogZoneSizeInput) {
            const zoneSize = button.dataset.targetZoneSize;
            dialogZoneSizeInput.value = zoneSize && zoneSize !== '' ? zoneSize : '';
        }

        // Show usage info if target is in use
        const isInUse = button.dataset.inUse === '1';
        const usages = button.dataset.usages || '';
        if (targetUsageInfo && targetUsageList) {
            if (isInUse && usages) {
                targetUsageList.textContent = usages;
                targetUsageInfo.hidden = false;
            } else {
                targetUsageInfo.hidden = true;
            }
        }

        if (typeof dialog.showModal === 'function') {
            dialog.showModal();
        } else {
            dialog.classList.add('is-open');
        }
    };

    const closeDialog = () => {
        if (!dialog) {
            return;
        }

        if (typeof dialog.close === 'function') {
            dialog.close();
        } else {
            dialog.classList.remove('is-open');
        }
    };

    const openLaneDialog = (button, isEditMode = true) => {
        if (!laneDialog || !laneForm || !laneToken || !laneNameInput || !laneDistanceInput) {
            return;
        }

        laneForm.setAttribute('action', button.dataset.action || '');
        laneToken.value = button.dataset.token || '';

        if (isEditMode) {
            const laneName = button.dataset.name || 'Lane';
            if (laneDialogTitle) {
                laneDialogTitle.textContent = 'Edit lane ' + laneName;
            }
            laneNameLabel.textContent = laneName;
            laneNameInput.value = laneName;
            laneDistanceInput.value = button.dataset.distance || '';
            if (laneTrainingInput) {
                laneTrainingInput.checked = button.dataset.forTrainingOnly === '1';
            }
            if (laneNotesInput) {
                laneNotesInput.value = button.dataset.notes || '';
            }
            if (laneSubmitBtn) {
                laneSubmitBtn.textContent = 'Save changes';
            }

            // Show usage info if lane is in use
            const isInUse = button.dataset.inUse === '1';
            const usages = button.dataset.usages || '';
            if (laneUsageInfo && laneUsageList) {
                if (isInUse && usages) {
                    laneUsageList.textContent = usages;
                    laneUsageInfo.hidden = false;
                } else {
                    laneUsageInfo.hidden = true;
                }
            }
        } else {
            if (laneDialogTitle) {
                laneDialogTitle.textContent = 'Add lane';
            }
            laneNameLabel.textContent = '';
            laneNameInput.value = '';
            laneDistanceInput.value = '';
            if (laneTrainingInput) {
                laneTrainingInput.checked = false;
            }
            if (laneNotesInput) {
                laneNotesInput.value = '';
            }
            if (laneSubmitBtn) {
                laneSubmitBtn.textContent = 'Add lane';
            }
            // Hide usage info in add mode
            if (laneUsageInfo) {
                laneUsageInfo.hidden = true;
            }
        }

        if (typeof laneDialog.showModal === 'function') {
            laneDialog.showModal();
        } else {
            laneDialog.classList.add('is-open');
        }
    };

    const openTargetAddDialog = (button) => {
        if (!targetAddDialog || !targetAddForm || !targetAddToken) {
            return;
        }

        targetAddForm.setAttribute('action', button.dataset.action || '');
        targetAddToken.value = button.dataset.token || '';

        if (targetAddName) {
            targetAddName.value = '';
        }

        // Reset training checkbox and notes
        if (targetAddTrainingInput) {
            targetAddTrainingInput.checked = false;
        }
        if (targetAddNotesInput) {
            targetAddNotesInput.value = '';
        }

        // Reset zone size
        if (targetAddZoneSizeInput) {
            targetAddZoneSizeInput.value = '';
        }

        const modalDropzone = targetAddDialog.querySelector('[data-dropzone-modal]');
        if (modalDropzone) {
            const preview = modalDropzone.querySelector('.dropzone-preview');
            const content = modalDropzone.querySelector('.dropzone-content');
            const fileInput = modalDropzone.querySelector('input[type="file"]');
            if (preview) {
                preview.hidden = true;
            }
            if (content) {
                content.hidden = false;
            }
            if (fileInput) {
                fileInput.value = '';
            }
        }

        if (typeof targetAddDialog.showModal === 'function') {
            targetAddDialog.showModal();
        } else {
            targetAddDialog.classList.add('is-open');
        }
    };

    const closeTargetAddDialog = () => {
        if (!targetAddDialog) {
            return;
        }

        if (typeof targetAddDialog.close === 'function') {
            targetAddDialog.close();
        } else {
            targetAddDialog.classList.remove('is-open');
        }
    };

    const closeLaneDialog = () => {
        if (!laneDialog) {
            return;
        }

        if (typeof laneDialog.close === 'function') {
            laneDialog.close();
        } else {
            laneDialog.classList.remove('is-open');
        }
    };

    document.addEventListener('click', (event) => {
        const target = event.target;
        if (!(target instanceof Element)) {
            return;
        }

        const addLaneButton = target.closest('.js-add-lane');
        if (addLaneButton && addLaneButton instanceof HTMLElement) {
            event.preventDefault();
            openLaneDialog(addLaneButton, false);
            return;
        }

        const laneButton = target.closest('.js-edit-lane');
        if (laneButton && laneButton instanceof HTMLElement) {
            event.preventDefault();
            openLaneDialog(laneButton, true);
            return;
        }

        const addTargetButton = target.closest('.js-add-target');
        if (addTargetButton && addTargetButton instanceof HTMLElement) {
            event.preventDefault();
            openTargetAddDialog(addTargetButton);
            return;
        }

        const button = target.closest('.js-edit-target');
        if (!button || !(button instanceof HTMLElement)) {
            return;
        }

        event.preventDefault();
        openDialog(button);
    });

    if (dialogClose) {
        dialogClose.addEventListener('click', closeDialog);
    }

    if (dialog) {
        dialog.addEventListener('click', (event) => {
            if (event.target === dialog) {
                closeDialog();
            }
        });
    }

    if (laneClose) {
        laneClose.addEventListener('click', closeLaneDialog);
    }

    if (laneDialog) {
        laneDialog.addEventListener('click', (event) => {
            if (event.target === laneDialog) {
                closeLaneDialog();
            }
        });
    }

    if (targetAddClose) {
        targetAddClose.addEventListener('click', closeTargetAddDialog);
    }

    if (targetAddDialog) {
        targetAddDialog.addEventListener('click', (event) => {
            if (event.target === targetAddDialog) {
                closeTargetAddDialog();
            }
        });
    }

    // Handle file input change for edit dialog preview
    if (dialogImageInput && dialogPreview && dialogPreviewWrap) {
        const imageErrorEl = document.getElementById('target-edit-image-error');
        const maxImageSize = 20971520; // 20 MB
        const allowedImageTypes = ['image/jpeg', 'image/png', 'image/webp', 'image/gif'];

        const formatFileSize = (bytes) => {
            if (bytes >= 1048576) {
                return (bytes / 1048576).toFixed(1) + ' MB';
            }
            return (bytes / 1024).toFixed(1) + ' KB';
        };

        dialogImageInput.addEventListener('change', () => {
            const file = dialogImageInput.files && dialogImageInput.files[0];
            if (imageErrorEl) {
                imageErrorEl.textContent = '';
            }

            if (!file) {
                dialogPreviewWrap.hidden = true;
                return;
            }

            const errors = [];
            if (!allowedImageTypes.includes(file.type)) {
                errors.push('File type not allowed. Accepted: JPG, PNG, WEBP, GIF');
            }
            if (file.size > maxImageSize) {
                errors.push('File too large (' + formatFileSize(file.size) + '). Maximum: ' + formatFileSize(maxImageSize));
            }

            if (errors.length > 0) {
                if (imageErrorEl) {
                    imageErrorEl.textContent = errors.join(' ');
                }
                dialogImageInput.value = '';
                dialogPreviewWrap.hidden = true;
                return;
            }

            dialogPreview.src = URL.createObjectURL(file);
            dialogPreview.onload = () => URL.revokeObjectURL(dialogPreview.src);
            dialogPreviewWrap.hidden = false;
        });
    }

    // Initialize all modal dropzones (target add and attachment add dialogs)
    document.querySelectorAll('[data-dropzone-modal]').forEach((modalDropzone) => {
        const fileInput = modalDropzone.querySelector('input[type="file"]');
        const preview = modalDropzone.querySelector('.dropzone-preview');
        const previewImage = modalDropzone.querySelector('.dropzone-preview img');
        const previewName = modalDropzone.querySelector('.dropzone-filename');
        const content = modalDropzone.querySelector('.dropzone-content');
        const errorEl = modalDropzone.querySelector('.dropzone-error');

        // Validation configuration from data attributes
        const maxSize = parseInt(modalDropzone.dataset.maxSize || '0', 10);
        const allowedTypesRaw = modalDropzone.dataset.allowedTypes || '';
        const allowedTypes = allowedTypesRaw ? allowedTypesRaw.split(',') : [];

        const formatFileSize = (bytes) => {
            if (bytes >= 1048576) {
                return (bytes / 1048576).toFixed(1) + ' MB';
            }
            return (bytes / 1024).toFixed(1) + ' KB';
        };

        const validateFile = (file) => {
            const errors = [];

            // Check file type
            if (allowedTypes.length > 0 && !allowedTypes.includes(file.type)) {
                const typeLabels = allowedTypes.map(t => {
                    if (t === 'application/pdf') return 'PDF';
                    if (t === 'image/jpeg') return 'JPG';
                    if (t === 'image/png') return 'PNG';
                    if (t === 'image/webp') return 'WEBP';
                    if (t === 'image/gif') return 'GIF';
                    return t;
                });
                errors.push('File type not allowed. Accepted: ' + typeLabels.join(', '));
            }

            // Check file size
            if (maxSize > 0 && file.size > maxSize) {
                errors.push('File too large (' + formatFileSize(file.size) + '). Maximum: ' + formatFileSize(maxSize));
            }

            return errors;
        };

        const showError = (message) => {
            if (!errorEl) return;
            errorEl.textContent = message;
            errorEl.hidden = false;
            modalDropzone.classList.add('has-error');
        };

        const clearError = () => {
            if (!errorEl) return;
            errorEl.textContent = '';
            errorEl.hidden = true;
            modalDropzone.classList.remove('has-error');
        };

        const updateModalPreview = (file) => {
            if (!preview || !previewImage || !previewName || !content) {
                return;
            }

            // Only show image preview for image files, hide for PDFs
            if (file.type.startsWith('image/')) {
                previewImage.src = URL.createObjectURL(file);
                previewImage.onload = () => URL.revokeObjectURL(previewImage.src);
                previewImage.hidden = false;
            } else {
                previewImage.src = '';
                previewImage.hidden = true;
            }

            previewName.textContent = file.name;
            preview.hidden = false;
            content.hidden = true;
        };

        const resetModalPreview = () => {
            if (!preview || !previewImage || !previewName || !content) {
                return;
            }

            preview.hidden = true;
            content.hidden = false;
            previewImage.src = '';
            previewImage.hidden = false;
            previewName.textContent = '';
        };

        const handleFile = (file, dataTransfer) => {
            clearError();

            if (!file) {
                resetModalPreview();
                return false;
            }

            const errors = validateFile(file);
            if (errors.length > 0) {
                showError(errors.join(' '));
                resetModalPreview();
                if (fileInput) {
                    fileInput.value = '';
                }
                return false;
            }

            if (fileInput && dataTransfer) {
                fileInput.files = dataTransfer.files;
            }
            updateModalPreview(file);
            return true;
        };

        modalDropzone.addEventListener('dragenter', (event) => {
            event.preventDefault();
            modalDropzone.classList.add('is-dragging');
        });

        modalDropzone.addEventListener('dragover', (event) => {
            event.preventDefault();
            modalDropzone.classList.add('is-dragging');
        });

        modalDropzone.addEventListener('dragleave', () => {
            modalDropzone.classList.remove('is-dragging');
        });

        modalDropzone.addEventListener('drop', (event) => {
            event.preventDefault();
            modalDropzone.classList.remove('is-dragging');
            if (!fileInput) {
                return;
            }

            const [file] = event.dataTransfer.files;
            handleFile(file, event.dataTransfer);
        });

        if (fileInput) {
            fileInput.addEventListener('change', () => {
                const file = fileInput.files && fileInput.files[0];
                handleFile(file, null);
            });
        }
    });

    const refreshIconSelect = (nativeSelect) => {
        if (!(nativeSelect instanceof HTMLSelectElement)) {
            return;
        }

        const wrapper = nativeSelect.closest('[data-icon-select]');
        if (!wrapper) {
            return;
        }

        const trigger = wrapper.querySelector('.icon-select__trigger');
        const triggerIcon = trigger?.querySelector('.icon-select__icon');
        const triggerLabel = trigger?.querySelector('.icon-select__label');
        const options = Array.from(wrapper.querySelectorAll('.icon-select__option'));
        if (!trigger || options.length === 0) {
            return;
        }

        const value = nativeSelect.value;
        const match = options.find((option) => (option.dataset.value ?? '') === value) ?? options[0];
        const optionIcon = match.querySelector('.icon-select__icon');
        const optionLabel = match.querySelector('.icon-select__label');

        if (triggerIcon && optionIcon) {
            triggerIcon.innerHTML = optionIcon.innerHTML;
        }
        if (triggerLabel && optionLabel) {
            triggerLabel.textContent = optionLabel.textContent ?? '';
        }

        options.forEach((option) => {
            option.setAttribute('aria-selected', option === match ? 'true' : 'false');
        });
    };

    iconSelects.forEach((wrapper) => {
        if (!(wrapper instanceof HTMLElement)) {
            return;
        }

        const nativeSelect = wrapper.querySelector('select');
        const trigger = wrapper.querySelector('.icon-select__trigger');
        const options = Array.from(wrapper.querySelectorAll('.icon-select__option'));

        if (!(nativeSelect instanceof HTMLSelectElement) || !(trigger instanceof HTMLButtonElement)) {
            return;
        }

        const close = () => {
            wrapper.classList.remove('is-open');
            trigger.setAttribute('aria-expanded', 'false');
        };

        const open = () => {
            wrapper.classList.add('is-open');
            trigger.setAttribute('aria-expanded', 'true');
        };

        trigger.addEventListener('click', (event) => {
            event.preventDefault();
            if (wrapper.classList.contains('is-open')) {
                close();
            } else {
                open();
            }
        });

        options.forEach((option) => {
            option.addEventListener('click', () => {
                const value = option.dataset.value ?? '';
                nativeSelect.value = value;
                nativeSelect.dispatchEvent(new Event('change', { bubbles: true }));
                refreshIconSelect(nativeSelect);
                close();
            });
        });

        document.addEventListener('click', (event) => {
            const target = event.target;
            if (!(target instanceof Node) || !wrapper.contains(target)) {
                close();
            }
        });

        nativeSelect.addEventListener('change', () => refreshIconSelect(nativeSelect));
        refreshIconSelect(nativeSelect);
    });

    const total = rows.length;
    const usageSelect = document.getElementById('target-usage-filter');
    const update = () => {
        if (!input || !select) {
            return;
        }

        const term = input.value.trim().toLowerCase();
        const type = select.value;
        const usage = usageSelect ? usageSelect.value : '';
        let visible = 0;

        rows.forEach((row) => {
            const name = row.dataset.name || '';
            const rowType = row.dataset.type || '';
            const rowTraining = row.dataset.training || '';
            const matchesName = term === '' || name.includes(term);
            const matchesType = type === '' || rowType === type;
            const matchesUsage = usage === '' || rowTraining === usage;
            const show = matchesName && matchesType && matchesUsage;
            row.style.display = show ? '' : 'none';
            if (show) {
                visible += 1;
            }
        });

        if (countEl) {
            const hasFilter = term !== '' || type !== '' || usage !== '';
            if (!hasFilter || total === 0 || visible === total) {
                countEl.textContent = '';
            } else {
                countEl.textContent = `Showing ${visible} of ${total}`;
            }
        }

        if (emptyEl) {
            emptyEl.style.display = total > 0 && visible === 0 ? '' : 'none';
        }
    };

        if (input && select && reset) {
            input.addEventListener('input', update);
            select.addEventListener('change', update);
            if (usageSelect) {
                usageSelect.addEventListener('change', update);
            }
            reset.addEventListener('click', () => {
                input.value = '';
                select.value = '';
                if (usageSelect) {
                    usageSelect.value = '';
                }
                update();
                refreshIconSelect(select);
            });
            update();
        }

    // Lane filter logic
    const laneTotal = laneRows.length;
    const updateLanes = () => {
        if (!laneFilterInput || !laneFilterSelect) {
            return;
        }

        const term = laneFilterInput.value.trim().toLowerCase();
        const trainingFilter = laneFilterSelect.value;
        let visible = 0;

        laneRows.forEach((row) => {
            const name = row.dataset.name || '';
            const training = row.dataset.training || '';
            const matchesName = term === '' || name.includes(term);
            const matchesTraining = trainingFilter === '' || training === trainingFilter;
            const show = matchesName && matchesTraining;
            row.style.display = show ? '' : 'none';
            if (show) {
                visible += 1;
            }
        });

        if (laneCountEl) {
            const hasFilter = term !== '' || trainingFilter !== '';
            if (!hasFilter || laneTotal === 0 || visible === laneTotal) {
                laneCountEl.textContent = '';
            } else {
                laneCountEl.textContent = `Showing ${visible} of ${laneTotal}`;
            }
        }

        if (laneEmptyEl) {
            laneEmptyEl.style.display = laneTotal > 0 && visible === 0 ? '' : 'none';
        }
    };

    if (laneFilterInput && laneFilterSelect && laneFilterReset) {
        laneFilterInput.addEventListener('input', updateLanes);
        laneFilterSelect.addEventListener('change', updateLanes);
        laneFilterReset.addEventListener('click', () => {
            laneFilterInput.value = '';
            laneFilterSelect.value = '';
            updateLanes();
        });
        updateLanes();
    }
})();
</script>

{% include 'components/_attachment_scripts.html.twig' with {
    dialog_id: 'attachment-add-dialog'
} %}
{% endblock %}
